{% extends 'dashboard.html' %}
{% block menu_dashboard_class %}nav-link dash-active{% endblock %}
{% block menu_leave_class %}nav-link active{% endblock %}  
{% block title %}leave dashboard{% endblock %} 
{% block content %}
          
<div class="row">
    <div class="col col-sm-12 col-lg-6 mb-4">
        <div class="container">
            <div class="d-lg-flex gap-2">
                <div class="card flex-grow-1 ">
                    <div class="card-body">
                            <div class="badge badge-pending-leave">
                                <a class="d-flex justify-content-between" href="{% url 'pending_leave'%}">
                                    <div class="label">{{pending_leaves}}</div>
                                    <h6>Pending</h6>
                                </a>
                            </div>
                    </div>
                </div>
                <div class="card flex-grow-1">
                    <div class="card-body">
                            <div class="badge badge-approved-leave">
                                <a class="d-flex" href="{% url 'approved_leave'%}">
                                <div class="label">{{approved_leaves}}</div>
                                <h6>Approved</h6>
                                </a>
                            </div>
                    </div>
                </div>
                <div class="card flex-grow-1">
                    <div class="card-body">              
                            <div class="badge badge-rejected-leave">
                                <a class="d-flex" href="{% url 'rejected_leave'%}">
                                <div class="label">{{rejected_leaves}}</div>
                                <h6>Rejected</h6>
                                </a>
                            </div>
                    </div>
                </div>
            </div>
            <div class="col mt-2">
                <div class="card">
                    <div class="card-body">
                            <canvas id="leaveChart" width="400" height="300"></canvas>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col col-sm-12 col-lg-6">
        <div class="card">
            <div class="card-body">
                    <div class="mt-2 container d-flex justify-content-center btn-leave">
                            <a class="d-flex flex-grow-1" href="{% url 'add_leave_request' %}" >
                            <i class="bx bx-sm bx-calendar"></i>
                            <span>Request</span></a>
                      
                            {% if user.user_role ==  'employee' %}
                        
                                <a class="d-flex flex-grow-1" href="{% url 'approved_leave' %}" >
                                <i class="bx bx-sm bx-calendar"></i>
                                <span>Staff On Leave</span></a>
                        
                        {% endif %}
                        {% if user.user_role !=  'employee' %}
                       
                            <a class="d-flex flex-grow-1" href="{% url 'approve_leave' %}" >
                                    <div class="leave-approval-badge">{{leave_request_received}}</div>
                                <span>New Approval</span></a>
                        
                        {% endif %}

                        {% if user.user_role ==  'admin' or user.user_role ==  'hr admin' %}
                       
                            <a class="d-flex flex-grow-1" href="{% url 'employee_leave' %}" >
                                    <i class="bx bx-sm bx-spreadsheet"></i>
                                <span>Manage Leave</span></a>
                       
                        {% endif %}
              
                 </div>
            </div>
            <div class="col col-sm">
                <div class=" container mb-4">
                    <a href="#" class="list-group-item list-group-item-action d-flex w-100 justify-content-between" aria-current="true" style="background-color: #1A2C3A; color: #fff; ">
                        
                        <h5 class="mb-1">Leave</h5>
                        <small>Day</small>
                     
                    </a>
                    {% for leave_type in leave_types %}
                    <a href="#" class="list-group-item list-group-item-action d-flex w-100 justify-content-between">
                        <h5 class="mb-1 leave-type">{{leave_type.leave_type}}</h5>
                        <small class="text-muted">{{leave_type.number_of_leave_days}} days</small>
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>


<script>
$(document).ready(function() {
        $.ajax({
            url: "{% url 'get_leave_data' %}",
            type: 'GET', 
            success: function(response) {
                const leaveData = response.leave_data;
                const labels = [];
                const leaveTakenData = [];
                const leaveBalanceData = [];
                const capitalize = s => s && s[0].toUpperCase() + s.slice(1)

                leaveData.forEach(function(leave) {
                    labels.push(capitalize(leave.leave_type));
                    leaveTakenData.push(leave.leave_taken);
                    leaveBalanceData.push(leave.leave_balance);
                });

                const ctx = document.getElementById('leaveChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Leave Balance',
                                data: leaveBalanceData,
                                backgroundColor: "#1A2C3A",
                                // borderWidth: 1
                            },
                            {
                                label: 'Leave Taken',
                                data: leaveTakenData,
                                backgroundColor: "#00ADB5",
                                // borderWidth: 1,
                            },
                        ]
                    },
                    options: {
                        plugins: {
                            legend: {
                                display: false,
                                labels: {
                                    color: 'rgb(255, 99, 132)'
                                }
                            },
                            title: {
                            display: true,
                            text: 'Employee Leave Balance and Leave Taken'
                        }
                        },
                        responsive: true,
                        indexAxis: 'y',
                        scales: {
                            x: {
                                stacked: true,
                                grid: {
                                display: false
                                },
                                barPercentage: 2,
                                categoryPercentage: 2,
                                ticks: {
                                    autoSkip: false,
                                    // maxRotation: 90,
                                    // minRotation: 90,
                                    font: {
                                        size: 13,
                                    }
                                }
                            },
                            y: {
                                grid: {
                                display: false
                                },
                                stacked: true,
                                beginAtZero: true
                            }
                        }
                    }
                });
            },
            error: function(response) {
                console.log('Error:', response);
            }
        });
});
</script>

{% endblock %}